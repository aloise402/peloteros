<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PELOTEROS - Tabla & Juegos</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    body{font-family:system-ui,Arial,sans-serif;background:#0b1220;color:#e8eefc;margin:0}
    .container{max-width:1000px;margin:0 auto;padding:24px}
    .hidden{display:none}
    .table-wrapper{overflow:auto;background:#121a2b;border-radius:12px;padding:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08)}
    th{color:#9fb3d1;font-weight:600;font-size:13px;text-align:left}
    td{font-size:14px}
    .num{text-align:right}
    .tag{background:rgba(77,163,255,.12);color:#cfe5ff;padding:2px 8px;border-radius:999px;font-size:12px}
    .muted{color:#9fb3d1}
    .pill{font-size:12px;color:#9fb3d1}
    .games-list{list-style:none;padding:0;margin:0}
    .games-list li{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08)}
    #error{background:#2a0f13;border:1px solid #4b151b;color:#ffb3b8;padding:10px 12px;border-radius:8px;margin:10px 0}
    #loading{color:#9fb3d1;margin:8px 0}
  </style>
</head>
<body>
  <div class="container">
    <h1>‚öæ PELOTEROS</h1>
    <p class="muted">Tabla de posiciones y juegos de postemporada</p>

    <div id="loading">Cargando datos, por favor espera‚Ä¶</div>
    <div id="error" class="hidden"></div>
    <div id="last-updated" class="muted hidden"></div>

    <section id="standings-section" class="hidden">
      <h2>üèÜ Tabla de posiciones</h2>

      <div class="legend">
        <span class="legend-item postemporada">Postemporada (1-6)</span>
        <span class="legend-item wildcard">Wild Card (7-10)</span>
        <span class="legend-item aaa">AAA (11-12)</span>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Equipo</th>
              <th>Jugador</th>
              <th class="num">Prog</th>
              <th class="num">JJ</th>
              <th class="num">W</th>
              <th class="num">L</th>
              <th class="num">Por jugar</th>
              <th class="num">Pts</th>
              <th class="num">K</th>
            </tr>
          </thead>
          <tbody id="standings-body"></tbody>
        </table>
        <p class="muted" style="margin:8px 0 0 2px;">
          K = Cantidad de juegos que faltan para obtener participaci√≥n legal. Deben tener 12 o m√°s juegos jugados.
        </p>
      </div>
    </section>

    <section id="games-today-section" class="hidden">
      <h2>üìÖ Juegos de postemporada (jugados)</h2>
      <ul id="games-today-list" class="games-list"></ul>
    </section>
  </div>

  <script>
    const el = {
      loading: document.getElementById('loading'),
      error: document.getElementById('error'),
      updated: document.getElementById('last-updated'),
      standingsSection: document.getElementById('standings-section'),
      standingsBody: document.getElementById('standings-body'),
      gamesSection: document.getElementById('games-today-section'),
      gamesList: document.getElementById('games-today-list')
    };
    const show = x => x.classList.remove('hidden');
    const hide = x => x.classList.add('hidden');

    function parseGameString(s){
      const norm = (s||'').replace(/\s+/g,' ').trim();
      const parts = norm.split(' - ');
      if (parts.length >= 4) {
        const [homePart, awayPart, datePart, timePart] = parts;
        const splitLast = (txt) => {
          const i = txt.lastIndexOf(' ');
          if (i === -1) return { name: txt, score: '' };
          return { name: txt.slice(0,i), score: txt.slice(i+1) };
        };
        const h = splitLast(homePart);
        const a = splitLast(awayPart);
        return {
          home_team: h.name,
          home_score: h.score,
          away_team: a.name,
          away_score: a.score,
          ended_at_local: `${datePart} - ${timePart}`
        };
      }
      return { raw: s };
    }

    async function loadData(){
      hide(el.error);
      show(el.loading);
      try{
        const r = await fetch('/api/full', {cache:'no-store'});
        if(!r.ok){
          let msg = `HTTP ${r.status}`;
          try{ const j = await r.json(); if (j && j.error) msg = j.error; }catch(_){}
          throw new Error(msg);
        }
        const data = await r.json();

        if (data.last_updated) {
          el.updated.textContent = `√öltima actualizaci√≥n: ${data.last_updated}`;
          show(el.updated);
        }

        // Standings
        el.standingsBody.innerHTML = '';
        (data.standings || []).forEach((row, i) => {
          const tr = document.createElement('tr');
          if (i < 6) tr.classList.add('postemporada');
          else if (i < 10) tr.classList.add('wildcard');
          else if (i < 12) tr.classList.add('aaa');

          tr.innerHTML = `
            <td>${i+1}</td>
            <td>${row.team}</td>
            <td><span class="tag">${row.user}</span></td>
            <td class="num">${row.scheduled}</td>
            <td class="num">${row.played}</td>
            <td class="num">${row.wins}</td>
            <td class="num">${row.losses}</td>
            <td class="num">${row.remaining}</td>
            <td class="num">${row.points}</td>
            <td class="num">${(row.k !== undefined && row.k !== null) ? row.k : Math.max(0, 12 - (row.played || 0))}</td>
          `;
          el.standingsBody.appendChild(tr);
        });
        show(el.standingsSection);

        // Juegos postemporada
        el.gamesList.innerHTML = '';
        const games = data.games_today || [];
        if (games.length === 0) {
          el.gamesList.innerHTML = `<li class="muted">No hay juegos de postemporada registrados a√∫n.</li>`;
        } else {
          games.forEach(g => {
            let obj = g;
            if (typeof g === 'string') obj = parseGameString(g);
            const li = document.createElement('li');
            if (obj.raw) {
              li.textContent = obj.raw;
            } else {
              li.innerHTML = `
                <div><strong>${obj.home_team}</strong> ${obj.home_score} - ${obj.away_score} <strong>${obj.away_team}</strong></div>
                <div class="pill">${obj.ended_at_local}</div>
              `;
            }
            el.gamesList.appendChild(li);
          });
        }
        show(el.gamesSection);

      }catch(e){
        el.error.textContent = 'No se pudieron cargar los datos: ' + e.message;
        show(el.error);
      }finally{
        hide(el.loading);
      }
    }

    loadData();
  </script>












<section class="wc-bracket">
  <h2>Wild Card ‚Äî Bracket (Bo1)</h2>
  <div id="wc-bracket-root" aria-live="polite"></div>
</section>

<section class="pofs-bracket">
  <h2>Playoffs ‚Äî Bracket (QF/SF Bo5, Final Bo7)</h2>
  <div id="bracket8-root" aria-live="polite"></div>
</section>

<style>
/* ===== Base ===== */
.wc-bracket, .pofs-bracket { margin-top: 28px; }
.wc-bracket h2, .pofs-bracket h2 { margin: 0 0 12px 0; font-size: 1.2rem; }

/* ===== Tarjetas ===== */
.card {
  background: #0b1220; border: 1px solid #23314f; border-radius: 14px;
  padding: 12px 14px; line-height: 1.25;
  box-shadow: 0 0 0 1px rgba(255,255,255,0.03) inset;
}
.card small { opacity: .75; font-size: .85rem; display: block; margin-bottom: 6px; }

.team-line { font-weight: 700; font-size: .98rem; }
.team-name { color: #7aa2ff; } /* ‚Üê destaca nombres */
.score { opacity: .95; font-weight: 600; margin-left: 6px; }

.meta { margin-top: 6px; font-size: .82rem; font-weight: 600; letter-spacing: .2px; display:flex; gap:8px; align-items:center;}
.badge {
  display: inline-block; padding: 4px 8px; border-radius: 999px;
  border: 1px solid transparent; font-weight: 700; font-size: .76rem;
}
.is-jugado .badge    { background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.45); color: #7ee088; }
.is-pendiente .badge { background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.45); color: #f7ce77; }
.is-curso .badge     { background: rgba(59,130,246,.12); border-color: rgba(59,130,246,.45); color: #9ec5ff; }

.has-winner { border-color: rgba(34,197,94,.45); box-shadow: 0 0 0 1px rgba(34,197,94,.25) inset; }

/* ===== Layout WC (L‚ÜíR) ===== */
.wc-grid {
  display: grid; grid-template-columns: 1fr 84px 1fr; gap: 14px; align-items: start;
}
.col { display: grid; gap: 12px; }
.connector {
  height: 100%; display: grid; align-content: center; justify-items: center; gap: 28px;
}
.arrow { font-size: 40px; line-height: 1; opacity: .9; filter: drop-shadow(0 0 2px rgba(0,0,0,.5)); }

/* ===== Layout Bracket 8 (QF ‚Üí SF ‚Üí F) ===== */
.bracket-grid {
  display: grid; grid-template-columns: 1fr 84px 1fr 84px 1fr; gap: 14px; align-items: start;
}
.round-col { display: grid; gap: 12px; }
.round-title { opacity:.8; font-weight:700; margin-bottom:4px; }
</style>

<script>
async function fetchFull() {
  const res = await fetch('/api/full', { cache: 'no-cache' });
  return await res.json();
}
const up = s => (s || '').toUpperCase();

function statusClass(s) {
  const S = up(s);
  if (S === 'JUGADO') return 'is-jugado';
  if (S === 'EN CURSO') return 'is-curso';
  return 'is-pendiente';
}
function labelStatus(s) {
  const S = up(s);
  if (S === 'JUGADO') return 'JUGADO';
  if (S === 'EN CURSO') return 'EN CURSO';
  return 'PENDIENTE';
}

function gameCardSingle(g) {
  // Para WC (Bo1): usa g.score (√∫ltimo partido) y winner si existe
  const s = labelStatus(g.status);
  const cls = ['card', statusClass(s)];
  if (g.winner) cls.push('has-winner');

  const t1 = `<span class="team-name">${g.home || '-'}</span>`;
  const t2 = `<span class="team-name">${g.away || '-'}</span>`;
  const score = g.score ? `<span class="score">${g.score}</span>` : '';
  const winner = g.winner ? ` ‚Äî ganador: ${g.winner}` : '';
  const bo = g.best_of ? `Bo${g.best_of}` : 'Bo1';

  return `
    <div class="${cls.join(' ')}">
      <small>${g.id} ‚Ä¢ ${bo}</small>
      <div class="team-line">${t1} vs ${t2}${score}</div>
      <div class="meta"><span class="badge">${s}</span>${winner}</div>
    </div>
  `;
}

function gameCardSeries(g) {
  // Para QF/SF/F: g.series_score (ej: 2-1) y best_of 5/7
  const s = labelStatus(g.status);
  const cls = ['card', statusClass(s)];
  if (g.winner) cls.push('has-winner');

  const t1 = `<span class="team-name">${g.home || '-'}</span>`;
  const t2 = `<span class="team-name">${g.away || '-'}</span>`;
  const score = g.series_score ? `<span class="score">${g.series_score}</span>` : '';
  const winner = g.winner ? ` ‚Äî ganador: ${g.winner}` : '';
  const bo = g.best_of ? `Bo${g.best_of}` : '';

  return `
    <div class="${cls.join(' ')}">
      <small>${g.id} ${bo ? '‚Ä¢ ' + bo : ''}</small>
      <div class="team-line">${t1} vs ${t2}${score}</div>
      <div class="meta"><span class="badge">${s}</span>${winner}</div>
    </div>
  `;
}

function renderWC(bracket) {
  const root = document.getElementById('wc-bracket-root');
  if (!Array.isArray(bracket)) {
    root.innerHTML = '<p>No hay datos de Wild Card todav√≠a.</p>';
    return;
  }
  const [wc1, wc2, wc3] = bracket;
  root.innerHTML = `
    <div class="wc-grid">
      <div class="col">
        ${gameCardSingle(wc1)}
        ${gameCardSingle(wc2)}
      </div>
      <div class="connector">
        <div class="arrow">‚ûú</div>
        <div class="arrow">‚ûú</div>
      </div>
      <div class="col">
        ${gameCardSingle(wc3)}
      </div>
    </div>
  `;
}

function renderBracket8(br) {
  const root = document.getElementById('bracket8-root');
  if (!br || !br.quarters) {
    root.innerHTML = '<p>Esperando resoluci√≥n de Wild Card‚Ä¶</p>';
    return;
  }
  const qf = br.quarters || [];
  const sf = br.semis || [];
  const f  = br.final || null;

  root.innerHTML = `
    <div class="bracket-grid">
      <div class="round-col">
        <div class="round-title">Cuartos (Bo5)</div>
        ${qf.map(gameCardSeries).join('')}
      </div>
      <div class="connector"><div class="arrow">‚ûú</div></div>
      <div class="round-col">
        <div class="round-title">Semifinales (Bo5)</div>
        ${sf.map(gameCardSeries).join('')}
      </div>
      <div class="connector"><div class="arrow">‚ûú</div></div>
      <div class="round-col">
        <div class="round-title">Serie Mundial (Bo7)</div>
        ${f ? gameCardSeries(f) : ''}
        ${br.champion ? `<div class="card is-jugado"><small>Campe√≥n</small><div class="team-line"><span class="team-name">${br.champion}</span></div></div>` : ''}
      </div>
    </div>
  `;
}

async function renderPlayoffs() {
  const data = await fetchFull();
  renderWC(data.wildcard_bracket);
  renderBracket8(data.bracket8);
}

// pinta ahora y refresca cada 45s
renderPlayoffs();
setInterval(renderPlayoffs, 45000);
</script>




















</body>
</html>