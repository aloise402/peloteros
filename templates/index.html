<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PELOTEROS - Tabla & Juegos</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <div class="container">
    <h1>‚öæ PELOTEROS</h1>
    <p class="muted">Tabla de posiciones y juegos del d√≠a</p>

    <div id="loading">Cargando datos, por favor espera‚Ä¶</div>
    <div id="error" class="hidden"></div>
    <div id="last-updated" class="muted hidden"></div>

    <section id="standings-section" class="hidden">
      <h2>üèÜ Tabla de posiciones</h2>

      <div class="legend">
        <span class="legend-item postemporada">Postemporada (1-6)</span>
        <span class="legend-item wildcard">Wild Card (7-10)</span>
        <span class="legend-item aaa">AAA (11-14)</span>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Equipo</th>
              <th>Jugador</th>
              <th class="num">Prog</th>
              <th class="num">JJ</th>
              <th class="num">W</th>
              <th class="num">L</th>
              <th class="num">Por jugar</th>
              <th class="num">Pts</th>
              <th class="num">K</th>
            </tr>
          </thead>
          <tbody id="standings-body"></tbody>
        </table>
        <div class="legend-footnote">
  <p><strong>K</strong> = Juegos que faltan para cumplir con al menos <strong>12 juegos jugados</strong> (<span style="color:#4caf50;font-weight:bold;">Participaci√≥n LEGAL</span>)</p>
  <hr style="border:0;border-top:1px solid #555;margin:8px 0;">
  <p><strong>Equipos que no continuaron jugando la liga:</strong></p>
  <ul class="retired-list">
    <li><span class="retired">Reds</span> (Se retira antes de empezar)</li>
    <li><span class="retired">Rockies</span> (Se retir√≥)</li>
    <li><span class="retired">Rays</span> (Se retir√≥)</li>
    <li><span class="retired">Angels</span> (Se retir√≥)</li>
    <li><span class="retired">Cardinals</span> (Se retir√≤ por irresponsable)</li>
    <li><span class="retired">Athletics</span> (Se retir√≤ por irresponsable)</li>
    <li><span class="retired">Guardians</span> (Se retir√≤ por estudios)</li>
    <li><span class="retired">Mets</span> (Se retira por ordenes del jefe)</li>
  </ul>
</div>

      </div>
    </section>

    <section id="games-today-section" class="hidden">
      <h2>üìÖ Juegos jugados hoy</h2>
      <ul id="games-today-list" class="games-list"></ul>
    </section>
  </div>

  <script>
    const el = {
      loading: document.getElementById('loading'),
      error: document.getElementById('error'),
      updated: document.getElementById('last-updated'),
      standingsSection: document.getElementById('standings-section'),
      standingsBody: document.getElementById('standings-body'),
      gamesSection: document.getElementById('games-today-section'),
      gamesList: document.getElementById('games-today-list')
    };
    const show = x => x.classList.remove('hidden');
    const hide = x => x.classList.add('hidden');

    function parseGameString(s){
      const norm = (s||'').replace(/\s+/g,' ').trim();
      const parts = norm.split(' - ');
      if (parts.length >= 4) {
        const [homePart, awayPart, datePart, timePart] = parts;
        const splitLast = (txt) => {
          const i = txt.lastIndexOf(' ');
          if (i === -1) return { name: txt, score: '' };
          return { name: txt.slice(0,i), score: txt.slice(i+1) };
        };
        const h = splitLast(homePart);
        const a = splitLast(awayPart);
        return {
          home_team: h.name,
          home_score: h.score,
          away_team: a.name,
          away_score: a.score,
          ended_at_local: `${datePart} - ${timePart}`
        };
      }
      return { raw: s };
    }

    async function loadData(){
      hide(el.error);
      show(el.loading);
      try{
        const r = await fetch('/api/full', {cache:'no-store'});
        if(!r.ok){
          let msg = `HTTP ${r.status}`;
          try{ const j = await r.json(); if (j && j.error) msg = j.error; }catch(_){}
          throw new Error(msg);
        }
        const data = await r.json();

        if (data.last_updated) {
          el.updated.textContent = `√öltima actualizaci√≥n: ${data.last_updated}`;
          show(el.updated);
        }

        // Standings
        el.standingsBody.innerHTML = '';
        (data.standings || []).forEach((row, i) => {
          const tr = document.createElement('tr');

          // Zonas
          if (i < 6) tr.classList.add('postemporada');
          else if (i < 10) tr.classList.add('wildcard');
          else if (i < 14) tr.classList.add('aaa');

          tr.innerHTML = `
            <td>${i+1}</td>
            <td>${row.team}</td>
            <td><span class="tag">${row.user}</span></td>
            <td class="num">${row.scheduled}</td>
            <td class="num">${row.played}</td>
            <td class="num">${row.wins}</td>
            <td class="num">${row.losses}</td>
            <td class="num">${row.remaining}</td>
            <td class="num">${row.points}</td>
            <td class="num ${row.K > 0 ? 'k-warning' : ''}">${row.K}</td>
          `;
          el.standingsBody.appendChild(tr);
        });
        show(el.standingsSection);

        // Juegos de hoy
        el.gamesList.innerHTML = '';
        const games = data.games_today || [];
        if (games.length === 0) {
          el.gamesList.innerHTML = `<li class="muted">No hay juegos finalizados hoy.</li>`;
        } else {
          games.forEach(g => {
            let obj = g;
            if (typeof g === 'string') obj = parseGameString(g);
            const li = document.createElement('li');
            if (obj.raw) {
              li.textContent = obj.raw;
            } else {
              li.innerHTML = `
                <div><strong>${obj.home_team}</strong> ${obj.home_score} - ${obj.away_score} <strong>${obj.away_team}</strong></div>
                <div class="pill">${obj.ended_at_local}</div>
              `;
            }
            el.gamesList.appendChild(li);
          });
        }
        show(el.gamesSection);

      }catch(e){
        el.error.textContent = 'No se pudieron cargar los datos: ' + e.message;
        show(el.error);
      }finally{
        hide(el.loading);
      }
    }

    loadData();
  </script>
</body>
</html>
